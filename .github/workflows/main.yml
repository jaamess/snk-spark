name: Deploy Discord Bot

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3

    - name: Set up Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '20.11.1'

    - name: Install dependencies
      run: npm ci

    - name: Deploy to VPS
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.SSH_KEY }}
        script: |
          # Navigate to the bot directory
          cd /path/to/your/bot

          # Pull latest changes from GitHub
          git pull origin main

          # Install new dependencies if any
          npm ci

          # Stop the running bot if it exists
          pm2 stop bot || true

          # Restart bot with pm2
          pm2 start index.js --name "bot"

          # Save pm2 process list to restart on server reboot
          pm2 save

    - name: Notify deployment success (optional)
      run: |
        curl -X POST -H "Content-Type: application/json" \
        -d '{"content": "Bot successfully deployed!"}' \
        ${{ secrets.DISCORD_WEBHOOK_URL }}
